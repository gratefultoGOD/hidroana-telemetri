<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hidroana Telemetri - Mobil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #000;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        .overlay {
            position: absolute;
            z-index: 1000;
            pointer-events: none;
        }

        .panel {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            pointer-events: auto;
        }

        /* Top Left - Speed */
        .top-left {
            top: 5px;
            left: 5px;
        }

        .speed-box {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.95), rgba(0, 180, 90, 0.95));
            color: #000;
            padding: 5px 10px;
            border-radius: 6px;
            text-align: center;
            border: none;
        }

        .speed-value {
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }

        .speed-unit {
            font-size: 11px;
            opacity: 0.8;
        }

        .speed-avg {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* Top Center - Status */
        .top-center {
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .status-panel {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }

        .source-toggle {
            display: flex;
            gap: 2px;
            margin-left: 5px;
        }

        .src-btn {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            color: #888;
        }

        .src-btn.active {
            background: #00ff88;
            color: #000;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 6px #00ff88;
        }

        .status-dot.offline {
            background: #ff4444;
            box-shadow: 0 0 6px #ff4444;
        }

        /* Test Controls */
        .test-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            background: #00ff88;
            color: #000;
            /*font-weight: bold;*/
        }

        .test-btn.active {
            background: #ff4444;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4);
            }

            50% {
                box-shadow: 0 0 0 6px rgba(255, 68, 68, 0);
            }
        }

        .test-timer {
            font-family: monospace;
            font-size: 11px;
            font-weight: bold;
            color: #ff4444;
            background: rgba(255, 68, 68, 0.2);
            padding: 3px 8px;
            border-radius: 3px;
        }

        /* Top Right - Count */
        .top-right {
            top: 5px;
            right: 5px;
        }

        /* Left Panel - Below speed */
        .left-top {
            top: 80px;
            left: 5px;
        }

        .gps-panel {
            font-size: 10px;
            padding: 3px 6px;
        }

        .gps-panel span {
            color: #00ff88;
        }

        .left-panel {
            top: 130px;
            left: 5px;
            max-width: 200px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        /* Right Panel */
        .right-panel {
            top: 5px;
            right: 5px;
            margin-top: 100px;
            max-width: 140px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .panel-title {
            font-weight: bold;
            margin-bottom: 4px;
            padding-bottom: 3px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 11px;
        }

        .fuel-panel .panel-title,
        .fuel-panel .val {
            color: #ff6b35;
        }

        .joule-panel .panel-title,
        .joule-panel .val {
            color: #d4a0ff;
        }

        .battery-panel .panel-title,
        .battery-panel .val {
            color: #00d4ff;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2px 0;
            gap: 8px;
        }

        .lbl {
            color: #aaa;
            font-size: 11px;
        }

        .val {
            font-weight: bold;
            font-size: 12px;
        }

        .avg {
            font-size: 9px;
            color: #ffcc00;
            display: block;
            margin-top: 0px;
            margin-bottom: 2px;
            min-height: 10px;
        }

        /* Bottom Left - Battery */
        .bottom-left {
            bottom: 5px;
            left: 5px;
            max-width: 220px;
        }

        .bottom-center {
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 400px;
        }

        .battery-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
        }

        .battery-item {
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 3px;
            border-radius: 3px;
        }

        .battery-item .lbl {
            font-size: 9px;
            display: block;
        }

        .battery-item .val {
            font-size: 11px;
            display: block;
        }

        .battery-item .avg {
            font-size: 8px;
            display: block;
            color: #ffcc00;
        }

        /* Bottom Right - SOC */
        .bottom-right {
            bottom: 5px;
            right: 5px;
        }

        .soc-panel {
            text-align: center;
            min-width: 60px;
        }

        .soc-label {
            font-size: 11px;
            color: #aaa;
        }

        .soc-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
            line-height: 1.1;
        }

        .soc-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 2px;
            overflow: hidden;
        }

        .soc-fill {
            height: 100%;
            background: #00ff88;
            border-radius: 2px;
            transition: width 0.5s, background 0.3s;
        }

        .soc-avg {
            font-size: 9px;
            color: #aaa;
            margin-top: 2px;
        }

        .portrait-warning {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        @media (orientation: portrait) {
            .portrait-warning {
                display: flex;
            }
        }

        /* Masa√ºst√º g√∂r√ºn√ºm√º i√ßin optimizasyon */
        @media (min-width: 1024px) {
            .panel {
                padding: 10px 14px;
                border-radius: 8px;
                font-size: 14px;
            }

            .speed-value {
                font-size: 42px;
            }

            .speed-unit {
                font-size: 14px;
            }

            .speed-avg {
                font-size: 12px;
            }

            .status-panel {
                gap: 10px;
                font-size: 14px;
            }

            .src-btn {
                padding: 5px 12px;
                font-size: 12px;
            }

            .test-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .test-timer {
                font-size: 14px;
                padding: 5px 10px;
            }

            .gps-panel {
                font-size: 13px;
                padding: 6px 10px;
            }

            .left-top {
                top: 120px;
            }

            .left-panel {
                top: 200px;
                max-width: 180px;
                max-height: calc(100vh - 300px);
                overflow-y: auto;
            }

            .right-panel {
                margin-top: 150px;
                max-width: 180px;
                max-height: calc(100vh - 220px);
                overflow-y: auto;
            }

            .panel-title {
                font-size: 14px;
                margin-bottom: 6px;
                padding-bottom: 4px;
            }

            .data-row {
                margin: 3px 0;
            }

            .lbl {
                font-size: 12px;
            }

            .val {
                font-size: 13px;
            }

            .avg {
                font-size: 11px;
            }

            .bottom-left {
                max-width: 300px;
            }

            .battery-item {
                padding: 4px;
            }

            .battery-item .lbl {
                font-size: 10px;
            }

            .battery-item .val {
                font-size: 12px;
            }

            .battery-item .avg {
                font-size: 9px;
            }

            .soc-panel {
                min-width: 100px;
            }

            .soc-label {
                font-size: 16px;
            }

            .soc-value {
                font-size: 42px;
            }

            .soc-bar {
                height: 8px;
            }

            .soc-avg {
                font-size: 13px;
            }

            .status-dot {
                width: 12px;
                height: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="portrait-warning">
        <div style="font-size:48px;margin-bottom:16px;">üì±‚ÜîÔ∏è</div>
        <div style="font-size:18px;">L√ºtfen cihazƒ±nƒ±zƒ± yatay √ßevirin</div>
    </div>

    <div id="map"></div>
    <!-- Top Left - Speed -->
    <div class="overlay top-left">
        <div class="panel speed-box">
            <div class="speed-value" id="speed">0</div>
            <div class="speed-unit">km/h</div>
            <div class="speed-avg" id="speedAvg">15s:-- Ort:--</div>
        </div>
    </div>

    <!-- GPS Info - Below Speed -->
    <div class="overlay left-top">
        <div class="panel gps-panel">
            <div>LAT: <span id="lat">--</span></div>
            <div>LNG: <span id="lng">--</span></div>
            <div>GSM: <span id="gsm">--</span></div>
        </div>
    </div>

    <!-- Top Center - Status -->
    <div class="overlay top-center">
        <div class="panel status-panel">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Baƒülanƒ±yor</span>
            <span style="color:#666;font-size:8px;" id="lastUpdate"></span>
            <button class="test-btn" id="returnMain" onclick="window.location.href='/'">Ana Sayfa</button>
        </div>
    </div>

    <!-- Top Right - Count -->
    <div class="overlay top-right">
        <div class="panel">
            <div>Kayƒ±t: <span class="val" style="color:#00ff88;" id="dataCount">0</span></div>
        </div>
    </div>

    <!-- Left - Fuel Cell -->
    <div class="overlay left-panel">
        <div class="panel fuel-panel">
            <div class="panel-title">‚ö° YAKIT H√úCRESƒ∞</div>
            <div class="data-row"><span class="lbl">Voltaj</span><span class="val" id="fv">--</span>V</div>
            <div class="avg" id="fvAvg"></div>
            <div class="data-row"><span class="lbl">Akƒ±m</span><span class="val" id="fa">--</span>A</div>
            <div class="avg" id="faAvg"></div>
            <div class="data-row"><span class="lbl">G√º√ß</span><span class="val" id="fw">--</span>W</div>
            <div class="avg" id="fwAvg"></div>
            <div class="data-row"><span class="lbl">Dƒ±≈ü¬∞C</span><span class="val" id="fet">--</span></div>
            <div class="avg" id="fetAvg"></div>
            <div class="data-row"><span class="lbl">ƒ∞√ß¬∞C</span><span class="val" id="fit">--</span></div>
            <div class="avg" id="fitAvg"></div>
        </div>
    </div>

    <!-- Right - Joulemeter -->
    <div class="overlay right-panel">
        <div class="panel joule-panel">
            <div class="panel-title">‚öôÔ∏è JOULMETRE</div>
            <div class="data-row"><span class="lbl">Voltaj</span><span class="val" id="jv">--</span>V</div>
            <div class="avg" id="jvAvg"></div>
            <div class="data-row"><span class="lbl">Akƒ±m</span><span class="val" id="jc">--</span>A</div>
            <div class="avg" id="jcAvg"></div>
            <div class="data-row"><span class="lbl">G√º√ß</span><span class="val" id="jw">--</span>W</div>
            <div class="avg" id="jwAvg"></div>
            <div class="data-row"><span class="lbl">Enerji</span><span class="val" id="jwh">--</span>Wh</div>
            <div class="avg" id="jwhAvg"></div>
        </div>
    </div>

    <!-- Bottom Left - Battery -->
    <div class="overlay bottom-center">
        <div class="panel battery-panel">
            <div class="panel-title">üîã BATARYA</div>
            <div class="battery-grid">
                <div class="battery-item"><span class="lbl">Voltaj</span><span class="val" id="bv">--</span><span
                        class="avg" id="bvAvg"></span></div>
                <div class="battery-item"><span class="lbl">Akƒ±m</span><span class="val" id="bc">--</span><span
                        class="avg" id="bcAvg"></span></div>
                <div class="battery-item"><span class="lbl">G√º√ß</span><span class="val" id="bw">--</span><span
                        class="avg" id="bwAvg"></span></div>
                <div class="battery-item"><span class="lbl">Enerji</span><span class="val" id="bwh">--</span><span
                        class="avg" id="bwhAvg"></span></div>
                <div class="battery-item"><span class="lbl">Kalan</span><span class="val" id="ke">--</span><span
                        class="avg" id="keAvg"></span></div>
                <div class="battery-item"><span class="lbl">T1</span><span class="val" id="t1">--</span><span
                        class="avg" id="t1Avg"></span></div>
                <div class="battery-item"><span class="lbl">T2</span><span class="val" id="t2">--</span><span
                        class="avg" id="t2Avg"></span></div>
                <div class="battery-item"><span class="lbl">T3</span><span class="val" id="t3">--</span><span
                        class="avg" id="t3Avg"></span></div>
            </div>
        </div>
    </div>

    <!-- Bottom Right - SOC -->
    <div class="overlay bottom-right">
        <div class="panel soc-panel">
            <div class="soc-label">SOC</div>
            <div class="soc-value" id="soc">--%</div>
            <div class="soc-bar">
                <div class="soc-fill" id="socFill"></div>
            </div>
            <div class="soc-avg" id="socAvg"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, marker, currentBearing = 0;

        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([40.7128, -74.006], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            updateMarker([40.7128, -74.006]);
        }

        function updateMarker(pos) {
            const icon = L.divIcon({
                className: 'vehicle-marker',
                html: `<div style="transform:rotate(${currentBearing}deg);transition:transform 0.3s;">
                    <svg width="28" height="28" viewBox="0 0 28 28">
                        <path d="M14 2 L22 22 L14 17 L6 22 Z" fill="#00ff88" stroke="#000" stroke-width="1.5"/>
                    </svg></div>`,
                iconSize: [28, 28], iconAnchor: [14, 14]
            });
            if (marker) { marker.setLatLng(pos); marker.setIcon(icon); }
            else { marker = L.marker(pos, { icon }).addTo(map); }
        }

        function calcBearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            return ((Math.atan2(y, x) * 180 / Math.PI) + 360) % 360;
        }

        function setText(id, val) { const el = document.getElementById(id); if (el) el.textContent = val; }

        function updateDisplay(d) {
            setText('speed', Math.round(parseFloat(d.h) || 0));
            setText('lat', parseFloat(d.y || 0).toFixed(5));
            setText('lng', parseFloat(d.x || 0).toFixed(5));
            setText('gsm', d.gs || '--');
            setText('fv', d.fv || '--'); setText('fa', d.fa || '--'); setText('fw', d.fw || '--');
            setText('fet', d.fet || '--'); setText('fit', d.fit || '--');
            setText('bv', d.bv || '--'); setText('bc', d.bc || '--'); setText('bw', d.bw || '--');
            setText('bwh', d.bwh || '--'); setText('ke', d.ke || '--');
            setText('t1', d.t1 || '--'); setText('t2', d.t2 || '--'); setText('t3', d.t3 || '--');
            setText('jv', d.jv || '--'); setText('jc', d.jc || '--'); setText('jw', d.jw || '--'); setText('jwh', d.jwh || '--');

            const soc = parseFloat(d.soc) || 0;
            setText('soc', soc + '%');
            const fill = document.getElementById('socFill');
            if (fill) { fill.style.width = Math.min(soc, 100) + '%'; fill.style.background = soc > 50 ? '#00ff88' : soc > 20 ? '#ffaa00' : '#ff4444'; }

            if (d.x && d.y) {
                const newPos = [parseFloat(d.y), parseFloat(d.x)];
                if (marker) {
                    const old = marker.getLatLng();
                    if (Math.abs(old.lat - newPos[0]) > 0.00001 || Math.abs(old.lng - newPos[1]) > 0.00001)
                        currentBearing = calcBearing(old.lat, old.lng, newPos[0], newPos[1]);
                }
                updateMarker(newPos);
                map.panTo(newPos);
            }
            setOnline();
            setText('lastUpdate', new Date().toLocaleTimeString('tr-TR'));
        }

        function updateAverages(avg) {
            if (!avg) return;
            const a = avg.allTime;
            const r = avg.last15Seconds;

            setText('speedAvg', `15s:${r.h || '--'} Ort:${a.h || '--'}`);
            setText('fvAvg', `15s:${r.fv || '--'} Ort:${a.fv || '--'}`);
            setText('faAvg', `15s:${r.fa || '--'} Ort:${a.fa || '--'}`);
            setText('fwAvg', `15s:${r.fw || '--'} Ort:${a.fw || '--'}`);
            setText('fetAvg', `15s:${r.fet || '--'} Ort:${a.fet || '--'}`);
            setText('fitAvg', `15s:${r.fit || '--'} Ort:${a.fit || '--'}`);
            setText('bvAvg', `${r.bv || '--'}/${a.bv || '--'}`);
            setText('bcAvg', `${r.bc || '--'}/${a.bc || '--'}`);
            setText('bwAvg', `${r.bw || '--'}/${a.bw || '--'}`);
            setText('bwhAvg', `${r.bwh || '--'}/${a.bwh || '--'}`);
            setText('keAvg', `${r.ke || '--'}/${a.ke || '--'}`);
            setText('t1Avg', `${r.t1 || '--'}/${a.t1 || '--'}`);
            setText('t2Avg', `${r.t2 || '--'}/${a.t2 || '--'}`);
            setText('t3Avg', `${r.t3 || '--'}/${a.t3 || '--'}`);
            setText('socAvg', `15s:${r.soc || '--'}% Ort:${a.soc || '--'}%`);
            setText('jvAvg', `15s:${r.jv || '--'} Ort:${a.jv || '--'}`);
            setText('jcAvg', `15s:${r.jc || '--'} Ort:${a.jc || '--'}`);
            setText('jwAvg', `15s:${r.jw || '--'} Ort:${a.jw || '--'}`);
            setText('jwhAvg', `15s:${r.jwh || '--'} Ort:${a.jwh || '--'}`);
        }

        function setOnline() { document.getElementById('statusDot')?.classList.remove('offline'); setText('statusText', 'Baƒülƒ±'); }
        function setOffline() { document.getElementById('statusDot')?.classList.add('offline'); setText('statusText', 'Baƒülantƒ± Yok'); }

        async function fetchData() {
            try {
                const res = await fetch('/api/telemetry');
                if (res.ok) updateDisplay(await res.json()); else setOffline();
            } catch { setOffline(); }
        }

        async function fetchAverages() {
            try {
                const res = await fetch('/api/telemetry/averages');
                if (res.ok) updateAverages(await res.json());
            } catch { }
        }

        async function fetchCount() {
            try {
                const res = await fetch('/api/telemetry/count');
                if (res.ok) { const d = await res.json(); setText('dataCount', d.count); }
            } catch { }
        }

        // ============================================
        // SSE (Server-Sent Events) BAƒûLANTISI
        // ============================================
        let eventSource = null;
        let sseReconnectAttempts = 0;
        let isPollingMode = false;
        let pollingInterval = null;
        const MAX_SSE_RECONNECT_ATTEMPTS = 10;

        function connectToSSE() {
            if (eventSource) {
                eventSource.close();
            }

            console.log('üîå SSE baƒülantƒ±sƒ± kuruluyor...');
            eventSource = new EventSource('/api/telemetry/stream');

            eventSource.onopen = function () {
                console.log('‚úÖ SSE baƒülantƒ±sƒ± kuruldu');
                sseReconnectAttempts = 0;
                setOnline();
            };

            eventSource.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    updateDisplay(data);
                } catch (error) {
                    console.error('SSE mesaj parse hatasƒ±:', error);
                }
            };

            eventSource.onerror = function (error) {
                console.error('‚ùå SSE baƒülantƒ± hatasƒ±:', error);
                setOffline();
                eventSource.close();
                eventSource = null;

                if (sseReconnectAttempts < MAX_SSE_RECONNECT_ATTEMPTS) {
                    sseReconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, sseReconnectAttempts), 30000);
                    console.log(`üîÑ SSE yeniden baƒülanma denemesi ${sseReconnectAttempts}/${MAX_SSE_RECONNECT_ATTEMPTS} (${delay / 1000}s sonra)...`);
                    setTimeout(connectToSSE, delay);
                } else {
                    console.error('‚ùå SSE baƒülantƒ±sƒ± kurulamadƒ±. Polling moduna ge√ßiliyor...');
                    startPollingFallback();
                }
            };
        }

        function startPollingFallback() {
            if (isPollingMode) return;

            isPollingMode = true;
            console.log('üîÑ Polling modu aktif');

            pollingInterval = setInterval(fetchData, 100);

            // Her 60 saniyede SSE'yi tekrar dene
            setInterval(() => {
                if (isPollingMode) {
                    console.log('üîÑ SSE baƒülantƒ±sƒ± tekrar deneniyor...');
                    sseReconnectAttempts = 0;
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                    isPollingMode = false;
                    connectToSSE();
                }
            }, 60000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMap();

            // SSE baƒülantƒ±sƒ±nƒ± ba≈ülat (Event-Driven)
            connectToSSE();

            // Ortalama ve kayƒ±t sayƒ±sƒ± i√ßin interval
            fetchCount(); fetchAverages();
            setInterval(fetchAverages, 1000);
            setInterval(fetchCount, 1000);

            document.addEventListener('click', () => document.documentElement.requestFullscreen?.(), { once: true });

            console.log('üöÄ Mobil sayfa ba≈ülatƒ±ldƒ± - Event-Driven SSE modu');
        });

        window.addEventListener('orientationchange', () => setTimeout(() => map?.invalidateSize(), 100));
        window.addEventListener('resize', () => map?.invalidateSize());

        function checkLoginStatus() {
            fetch('/api/auth/check')
                .then(res => res.json())
                .then(data => {
                    if (!data.authenticated) {
                        window.location.href = '/login';
                    }
                })
                .catch(() => { });
        }

        // Baƒülantƒ± durumunu kontrol et
        function checkConnectionStatus() {
            fetch('/api/source/status')
                .then(res => res.json())
                .then(data => {
                    // Baƒülantƒ± durumunu g√ºncelle
                    if (data.connected) {
                        setOnline();
                    } else {
                        setOffline();
                    }
                })
                .catch(() => { });
        }
        checkLoginStatus();
        checkConnectionStatus();
        // Her 2 saniyede kontrol et
        setInterval(checkConnectionStatus, 2000);
    </script>
</body>

</html>